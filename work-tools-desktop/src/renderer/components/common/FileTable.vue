<script setup lang="ts">
import { computed, ref } from "vue";
import {
	type VxeGridInstance,
	type VxeGridProps,
	type VxeGridListeners,
} from "vxe-table";
import { useFileSystem } from "../../composables/useFileSystem";
import { useFileStore } from "../../stores/fileStore";
import { useErrorHandler } from "../../composables/useErrorHandler";
import type { FileItem } from "../../types/file";
import * as XLSX from "xlsx";

// Props
interface ColumnConfig {
	field: string;
	title: string;
	width?: number | string;
	minWidth?: number | string;
	sortable?: boolean;
	align?: string;
	editRender?: any;
	slots?: any;
	visible?: boolean;
	[key: string]: any; // 允许其他 vxe-table 列配置属性
}

interface Props {
	showMatchInfo?: boolean;
	showPreview?: boolean;
	showSelection?: boolean;
	showExecutionResult?: boolean; // 是否显示执行结果列
	fileStore?: any; // 可选的外部store实例
	columns?: ColumnConfig[]; // 动态列配置
}

const props = withDefaults(defineProps<Props>(), {
	showMatchInfo: false,
	showPreview: false,
	showSelection: true,
	showExecutionResult: false, // 默认不显示执行结果列
	fileStore: undefined,
});

// Emits
const emit = defineEmits<{
	(e: "file-selected", file: FileItem): void;
	(e: "selection-changed", selectedFiles: FileItem[]): void;
}>();

// 错误处理和日志记录
const { handleSuccess, handleError, logOperation } = useErrorHandler();

// 状态管理
const internalFileStore = useFileStore();
const fileStore = computed(() => props.fileStore || internalFileStore);
const { formatFileSize, openFileInFolder, renameFile, writeFile } =
	useFileSystem();

// 表格引用
const gridRef = ref<VxeGridInstance<FileItem>>();

// 本地状态
const searchQuery = ref("");

// 计算属性
const filteredFiles = computed(() => {
	let files = [...fileStore.value.files];

	// 搜索过滤
	if (searchQuery.value.trim()) {
		const query = searchQuery.value.toLowerCase();
		files = files.filter(
			(file) =>
				file.name.toLowerCase().includes(query) ||
				file.path.toLowerCase().includes(query) ||
				(file.matchInfo?.matchedRule &&
					file.matchInfo.matchedRule.toLowerCase().includes(query))
		);
	}

	return files;
});

// Grid配置 - 配置式表格
const gridOptions = computed<VxeGridProps<FileItem>>(() => {
	return {
		border: true,
		height: "100%",
		loading: fileStore.value.isLoading,
		keepSource: true, // 添加 keep-source 配置
		rowConfig: {
			keyField: "id", // 添加唯一键字段，解决 row-config.keyField 警告
			isCurrent: true,
			isHover: true,
			drag: true, // 启用行拖拽
			dragSort: true, // 启用行拖拽排序
		},
		columnConfig: {
			resizable: true,
			drag: true, // 启用列拖拽
			fit: true,
			autoOptions: {
				isCalcHeader: false, // 不自适应计算列头宽度
				isCalcBody: true,
				isCalcFooter: true,
			},
		},
		sortConfig: {
			remote: false, // 本地排序，让 VXE Table 处理
			trigger: "default",
		},
		checkboxConfig: props.showSelection
			? {
					highlight: true,
					reserve: true,
					range: true,
					trigger: "cell",
			  }
			: undefined,
		editConfig: {
			trigger: "click",
			mode: "cell",
		},
		scrollX: {
			enabled: true,
			gt: 0,
		},
		scrollY: {
			enabled: true,
			gt: 100,
		},
		className: "file-table",
		data: filteredFiles.value,
		columns: getColumnsConfig(),
	};
});

// 列配置函数
function getColumnsConfig() {
	// 如果传入了动态列配置，则使用动态配置
	const finalConls: any[] = [];
	// 选择列
	if (props.showSelection) {
		finalConls.push({
			type: "checkbox",
			width: 50,
			fixed: "left",
		});
	}

	// 序号列 - 作为第一列，添加拖拽排序配置
	finalConls.push({
		field: "index",
		title: "序号",
		width: 80,
		align: "center",
		dragSort: true, // 启用序号列拖拽排序
		slots: { default: "index-slot" },
	});

	// 文件名列
	finalConls.push({
		field: "name",
		title: "文件名",
		minWidth: 200,
		sortable: true,
		editRender: { name: "input", autoselect: true },
		slots: { default: "name-slot", edit: "name-edit-slot" },
	});

	// 文件大小列（仅在非重命名器和非匹配器时显示）
	if (!props.showPreview && !props.showMatchInfo) {
		finalConls.push({
			field: "size",
			title: "大小",
			width: 120,
			sortable: true,
			align: "right",
			slots: { default: "size-slot" },
		});
	}

	// 最后修改时间列
	finalConls.push({
		field: "lastModified",
		title: "修改时间",
		width: 180,
		sortable: true,
		slots: { default: "date-slot" },
	});

	// 操作列
	finalConls.push({
		field: "actions",
		title: "操作",
		width: 120,
		align: "center",
		slots: { default: "actions-slot" },
	});

	// 匹配信息列
	if (props.showMatchInfo) {
		finalConls.push({
			field: "matchInfo",
			title: "匹配结果",
			width: 150,
			sortable: true,
			slots: { default: "match-slot" },
		});

		// 匹配规则列
		finalConls.push({
			field: "matchedRule",
			title: "匹配规则",
			width: 150,
			sortable: true,
			slots: { default: "matched-rule-slot" },
		});
	}

	// 预览名称列
	if (props.showPreview) {
		finalConls.push({
			field: "previewName",
			title: "预览名称",
			minWidth: 200,
			slots: { default: "preview-slot" },
		});
	}

	// 执行结果列
	if (props.showExecutionResult) {
		finalConls.push({
			field: "executionResult",
			title: "执行结果",
			minWidth: 150,
			slots: { default: "result-slot" },
		});
	}

	if (props.columns && props.columns.length > 0) {
		// 添加动态列配置
		props.columns.forEach((col) => {
			// 为规则动态列添加插槽配置
			const columnConfig = {
				...col,
				slots: { default: `${col.field}-slot` },
			};
			finalConls.push(columnConfig);
		});
	}
	return finalConls;
}

function handleSelectChange() {
	const selectedRecords = gridRef.value?.getCheckboxRecords() || [];
	emit("selection-changed", selectedRecords as FileItem[]);
}

function handleCurrentChange(params: any) {
	const { row } = params;
	if (row) {
		emit("file-selected", row as FileItem);
	}
}

function formatDate(timestamp: number): string {
	return new Date(timestamp).toLocaleString("zh-CN");
}

function getMatchStatusText(file: FileItem): string {
	if (!file.matched) return "未匹配";
	return file.matchInfo?.code || "已匹配";
}

function getMatchStatusClass(file: FileItem): string {
	return file.matched ? "text-green-600 font-medium" : "text-gray-500";
}

// 打开文件所在文件夹
async function handleOpenFolder(file: FileItem) {
	try {
		const result = await openFileInFolder(file.path);
		if (!result) {
			console.error("无法打开文件夹:", file.path);
		}
	} catch (error) {
		console.error("打开文件夹时出错:", error);
	}
}

// 移除单个文件
function handleRemoveFile(file: FileItem) {
	// 确认对话框防止误操作
	if (confirm(`确定要移除文件 "${file.name}" 吗？`)) {
		fileStore.value.removeFile(file.id);
	}
}

// 批量移除文件
function handleRemoveSelectedFiles() {
	const selectedFiles = getSelectedFiles();
	if (selectedFiles.length === 0) return;

	// 确认对话框防止误操作
	if (confirm(`确定要移除选中的 ${selectedFiles.length} 个文件吗？`)) {
		const fileIds = selectedFiles.map((file) => file.id);
		fileStore.value.removeFiles(fileIds);
		unselectAll();
	}
}

const gridEvents: VxeGridListeners<FileItem> = {
	editClosed({ row }) {
		handleNameEditComplete(row);
	},
};

// 编辑相关方法
async function handleNameEditComplete(row: any) {
	// 从事件参数中获取行数据

	// 触发表格退出编辑状态
	gridRef.value?.clearEdit();

	// 获取原始文件名
	const originalFile = fileStore.value.files.find(
		(file: FileItem) => file.id === row.id
	);

	if (!originalFile) {
		console.error("找不到原始文件");
		handleError(new Error("找不到原始文件"), "文件重命名");
		return;
	}

	// 如果文件名没有改变，直接返回
	const originalName = originalFile.previewName;
	if (originalName === row.name) {
		return;
	}

	// 构造新的文件路径
	const newPath = row.path.replace(originalName, row.name);

	try {
		// 调用重命名文件的API
		const result = await renameFile(originalFile.path, newPath);

		if (result?.success) {
			// 更新文件存储中的数据
			const fileIndex = fileStore.value.files.findIndex(
				(file: FileItem) => file.id === row.id
			);
			if (fileIndex !== -1) {
				// 创建新的文件数组以触发响应式更新
				const newFiles = [...fileStore.value.files];
				newFiles[fileIndex] = { ...row, path: newPath };
				fileStore.value.files = newFiles;
			}

			// 显示成功提示
			handleSuccess(
				`文件 "${originalName}" 已成功重命名为 "${row.name}"`,
				"重命名成功"
			);

			// 记录操作日志
			logOperation(
				"文件重命名",
				`文件 "${originalName}" 已成功重命名为 "${row.name}"`,
				{
					renameDetails: [{ oldName: originalName, newName: row.name }],
				}
			);
		} else {
			// 重命名失败，恢复原始文件名
			row.name = originalFile.name;
			console.error("文件重命名失败:", result?.error);

			// 显示错误提示
			handleError(new Error(result?.error || "文件重命名失败"), "文件重命名");

			// 记录操作日志
			logOperation(
				"文件重命名",
				`文件 "${originalName}" 重命名为 "${row.name}" 失败: ${
					result?.error || "未知错误"
				}`,
				null,
				null,
				{
					level: "error",
				}
			);
		}
	} catch (error) {
		// 重命名失败，恢复原始文件名
		row.name = originalFile.name;
		console.error("文件重命名时出错:", error);

		// 显示错误提示
		handleError(error, "文件重命名");

		// 记录操作日志
		logOperation(
			"文件重命名",
			`文件 "${originalName}" 重命名为 "${row.name}" 时发生异常: ${
				error instanceof Error ? error.message : String(error)
			}`,
			null,
			null,
			{
				level: "error",
			}
		);
	}
}

function handleRowDragEnd(params: any) {
	// VXE Table 会自动更新数据顺序，我们需要同步到 fileStore
	const newData = gridRef.value?.getTableData().fullData || [];
	fileStore.value.files = [...newData];
}

// 公共方法
function selectAll() {
	if (!props.showSelection) return;
	gridRef.value?.setAllCheckboxRow(true);
	handleSelectChange();
}

function unselectAll() {
	if (!props.showSelection) return;
	gridRef.value?.setAllCheckboxRow(false);
	handleSelectChange();
}

function getSelectedFiles(): FileItem[] {
	return (gridRef.value?.getCheckboxRecords() || []) as FileItem[];
}

function setSearchQuery(query: string) {
	searchQuery.value = query;
}

// 导出 Excel 文件
async function exportExcel() {
	const $grid = gridRef.value;
	if (!$grid) {
		console.error("🔧 [DEBUG] Grid 引用为空，无法导出");
		return;
	}

	try {
		console.log("🔧 [DEBUG] 开始 Excel 导出");

		// 获取表格数据
		const tableData = $grid.getTableData();
		const { fullData } = tableData;

		console.log("🔧 [DEBUG] 获取到表格数据条数:", fullData.length);

		if (fullData.length === 0) {
			console.warn("🔧 [DEBUG] 没有数据可导出");
			emit("export", { success: false, message: "没有数据可导出" });
			return;
		}

		// 生成 Excel 工作表数据
		const worksheetData = generateExcelWorksheetData(fullData);
		console.log("🔧 [DEBUG] Excel 工作表数据生成完成");

		// 创建工作簿
		const ws = XLSX.utils.aoa_to_sheet(worksheetData);
		const wb = XLSX.utils.book_new();
		XLSX.utils.book_append_sheet(wb, ws, "文件列表");

		// 设置列宽
		ws["!cols"] = worksheetData[0].map(() => ({ width: 15 }));

		// 生成 Excel 文件内容
		const excelBuffer = XLSX.write(wb, { bookType: "xlsx", type: "array" });

		// 调用 Electron 文件保存对话框
		const result = await (window as any).electronAPI?.dialog?.showSaveDialog({
			defaultPath: `file-table-export-${
				new Date().toISOString().split("T")[0]
			}.xlsx`,
			filters: [
				{ name: "Excel Files", extensions: ["xlsx"] },
				{ name: "All Files", extensions: ["*"] },
			],
		});

		console.log("🔧 [DEBUG] 文件保存对话框结果:", result);

		if (!result.canceled && result.filePath) {
			// 写入文件
			const writeResult = await writeFile(result.filePath, excelBuffer);

			console.log("🔧 [DEBUG] 文件写入结果:", writeResult);

			if (writeResult?.success) {
				console.log("✅ Excel 导出成功:", result.filePath);
				emit("export", {
					success: true,
					message: `成功导出 ${fullData.length} 个文件到 ${result.filePath}`,
					fileCount: fullData.length,
					filePath: result.filePath,
					fileNames: fullData.map((file: FileItem) => file.name),
				});
			} else {
				console.error("❌ Excel 导出失败:", writeResult);
				emit("export", {
					success: false,
					message: `导出失败: ${writeResult?.error || "未知错误"}`,
					fileCount: fullData.length,
				});
			}
		} else {
			emit("export", { success: false, message: "用户取消了导出操作" });
		}
	} catch (error) {
		console.error("🔧 [DEBUG] Excel 导出出错:", error);
		emit("export", {
			success: false,
			message: `导出过程中发生错误: ${error}`,
			error: error,
		});
	}
}

// 生成 Excel 工作表数据
function generateExcelWorksheetData(data: FileItem[]): any[][] {
	console.log("🔧 [DEBUG] 开始生成Excel工作表数据");

	// 获取当前表格的实时列配置
	const $grid = gridRef.value;
	if (!$grid) {
		console.error("🔧 [DEBUG] Grid引用为空");
		return [];
	}

	// 获取当前显示的列配置（考虑拖拽排序）
	const tableColumns = $grid.getColumns();
	console.log(
		"🔧 [DEBUG] 当前表格列配置:",
		tableColumns.map((col) => ({
			field: col.field,
			title: col.title,
			type: col.type,
			visible: col.visible,
		}))
	);

	// 根据实时列配置生成表头
	const headers: string[] = [];
	const validColumns = tableColumns.filter(
		(col) => col.visible !== false && col.type !== "checkbox" && col.title && col.field !== "actions" && col.field !== "index"
	);

	console.log(
		"🔧 [DEBUG] 有效导出列:",
		validColumns.map((col) => ({
			field: col.field,
			title: col.title,
		}))
	);

	validColumns.forEach((col) => {
		headers.push(col.title || col.field || "");
	});

	console.log("🔧 [DEBUG] 实时生成的表头:", headers);

	// 生成 Excel 工作表数据
	const worksheetData = [headers];

	data.forEach((file, index) => {
		console.log("🔧 [DEBUG] 处理文件:", file.name, "索引:", index);

		// 根据实时列配置生成数据行
		const row: any[] = [];

		validColumns.forEach((col) => {
			let cellValue = "";

			switch (col.field) {
				case "index":
					cellValue = index + 1;
					break;
				case "name":
					cellValue = file.name;
					break;
				case "size":
					cellValue = formatFileSize(file.size);
					break;
				case "lastModified":
					cellValue = formatDate(file.lastModified);
					break;
				case "matchInfo":
					cellValue = getMatchStatusText(file);
					break;
				case "matchedRule":
					cellValue =
						file.matched && file.matchInfo?.matchedRule
							? file.matchInfo.matchedRule
							: "-";
					break;
				case "previewName":
					cellValue = file.previewName || "";
					break;
				default:
					// 处理动态列 - 从 matchInfo.columnValues 中获取值
					if (file.matched && file.matchInfo?.columnValues?.[col.field]) {
						cellValue = file.matchInfo.columnValues[col.field];
					} else {
						cellValue = "-";
					}
					break;
			}

			row.push(cellValue);
		});

		console.log("🔧 [DEBUG] 生成的数据行:", row);
		worksheetData.push(row);
	});

	return worksheetData;
}

// 导出数据 - 统一使用Excel格式
async function exportData() {
	await exportExcel();
}

// 暴露方法给父组件
defineExpose({
	selectAll,
	unselectAll,
	getSelectedFiles,
	setSearchQuery,
	exportExcel,
	exportData,
});

// VXE Table 通过配置自动处理数据响应，无需手动监听
</script>

<template>
	<div class="file-table-container flex flex-col h-full">
		<!-- 搜索栏 -->
		<div
			class="search-bar p-2 border-b border-border-primary bg-background-secondary flex-shrink-0 flex items-center gap-2"
		>
			<div class="relative flex-1">
				<input
					v-model="searchQuery"
					type="text"
					placeholder="搜索文件名、路径或匹配信息..."
					class="input-base w-full pl-8 pr-8 py-1.5 text-sm"
				/>
				<div
					class="absolute inset-y-0 left-0 pl-2.5 flex items-center pointer-events-none"
				>
					<span class="text-gray-400 text-sm">🔍</span>
				</div>
				<div
					v-if="searchQuery"
					class="absolute inset-y-0 right-0 pr-2.5 flex items-center"
				>
					<button
						@click="searchQuery = ''"
						class="text-gray-400 hover:text-gray-600 focus:outline-none text-sm"
					>
						<span>✕</span>
					</button>
				</div>
			</div>
			<button
				v-if="props.showSelection && fileStore?.value?.selectedFiles?.size > 0"
				@click="handleRemoveSelectedFiles"
				class="btn-secondary px-3 py-1.5 text-sm whitespace-nowrap"
				title="移除选中文件"
			>
				移除选中 ({{ fileStore.value.selectedFiles.size }})
			</button>
		</div>

		<!-- 文件表格 - 关键修复：强制设置具体高度和滚动 -->
		<div
			v-if="filteredFiles.length > 0"
			class="table-container flex-1 min-h-0 relative"
		>
			<!-- 使用绝对定位确保表格占据剩余空间 -->
			<div class="absolute inset-0">
				<vxe-grid
					ref="gridRef"
					v-on="gridEvents"
					v-bind="gridOptions"
					height="100%"
					:scroll-y="{ enabled: true }"
					:scroll-x="{ enabled: true }"
					@checkbox-change="handleSelectChange"
					@checkbox-all="handleSelectChange"
					@current-change="handleCurrentChange"
					@row-dragend="handleRowDragEnd"
				>
					<!-- 所有插槽保持不变 -->
					<template #index-slot="{ rowIndex }">
						<span class="text-text-secondary font-medium text-xs">
							{{ rowIndex + 1 }}
						</span>
					</template>
					<template #name-slot="{ row }">
						<div class="flex items-center">
							<span class="mr-1.5 text-sm">📄</span>
							<span
								class="truncate font-medium text-text-primary text-sm"
								:title="row.name"
							>
								{{ row.name }}
							</span>
						</div>
					</template>
					<template #name-edit-slot="{ row }">
						<input
							v-model="row.name"
							type="text"
							class="input-base w-full text-sm"
						/>
					</template>
					<template #size-slot="{ row }">
						<span class="text-text-secondary text-xs">
							{{ formatFileSize(row.size) }}
						</span>
					</template>
					<template #date-slot="{ row }">
						<span class="text-text-secondary text-xs">
							{{ formatDate(row.lastModified) }}
						</span>
					</template>
					<template #match-slot="{ row }">
						<span :class="getMatchStatusClass(row)" class="text-xs">
							{{ getMatchStatusText(row) }}
						</span>
					</template>
					<template #matched-rule-slot="{ row }">
						<span
							v-if="row.matched && row.matchInfo?.matchedRule"
							class="text-xs"
						>
							{{ row.matchInfo.matchedRule }}
						</span>
						<span v-else class="text-text-tertiary text-xs">-</span>
					</template>
					<template #preview-slot="{ row }">
						<span
							v-if="row.previewName"
							class="text-text-secondary italic text-xs"
							:title="row.previewName"
						>
							{{ row.previewName }}
						</span>
						<span v-else class="text-text-tertiary italic text-xs">
							无预览
						</span>
					</template>
					<template #result-slot="{ row }">
						<span
							v-if="row.executionResult"
							:class="{
								'text-green-600':
									row.executionResult.includes('成功') ||
									row.executionResult.includes('完成'),
								'text-red-600':
									row.executionResult.includes('失败') ||
									row.executionResult.includes('错误'),
							}"
							:title="row.executionResult"
							class="text-xs"
						>
							{{ row.executionResult }}
						</span>
						<span v-else class="text-text-tertiary text-xs"> 未执行 </span>
					</template>
					<template #actions-slot="{ row }">
						<div class="flex gap-1">
							<button
								@click="handleOpenFolder(row)"
								class="btn-secondary px-2 py-1 text-xs flex-1"
								title="打开文件所在文件夹"
							>
								📁
							</button>
							<button
								@click="handleRemoveFile(row)"
								class="btn-secondary px-2 py-1 text-xs flex-1"
								title="移除文件"
							>
								❌
							</button>
						</div>
					</template>
					<template
						v-for="column in props.columns"
						:key="column.field"
						#[`${column.field}-slot`]="{ row }"
					>
						<span
							v-if="row.matched && row.matchInfo?.columnValues?.[column.field]"
							class="text-xs"
						>
							{{ row.matchInfo.columnValues[column.field] }}
						</span>
						<span v-else class="text-text-tertiary text-xs">-</span>
					</template>
				</vxe-grid>
			</div>
		</div>

		<!-- 空状态 -->
		<div
			v-else
			class="empty-state flex-1 flex flex-col items-center justify-center p-8 text-center"
		>
			<div class="text-4xl sm:text-5xl mb-4 opacity-50">📁</div>
			<div class="text-base font-medium text-text-secondary mb-2">
				{{ searchQuery ? "未找到匹配的文件" : "暂无文件" }}
			</div>
			<div class="text-xs sm:text-sm text-text-tertiary">
				{{ searchQuery ? "尝试调整搜索条件" : "请选择文件或拖拽文件到此处" }}
			</div>
			<slot name="empty"></slot>
		</div>
	</div>
</template>
